<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Nest Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />
        <!-- Favicon -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

        <link rel="shortcut icon" type="image/x-icon" href="/admin/imgs/theme/favicon.svg" />
        <!-- Template CSS -->
        <link href="/admin/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
        
        <link rel="stylesheet" href="/toast.css">
        <style> .error-message {
            color: red;
            font-size: 12px;
          }</style>
    </head>

    <body>
        <div class="screen-overlay"></div>
        <%-include('../partials/sidebar.ejs') %>
        <!--  -->
        <div class="toast-container" id="toastContainer"></div>
        <main class="main-wrap">
           
            <%-include('../partials/adminHeader')%>
            <section class="content-main">
                <div class="container mx-auto px-4 py-8" >
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-semibold text-gray-700">Add New Product</h1>
                       
                    </div>
            
                    <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Basic Information Section -->
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-xl font-semibold mb-6 text-gray-700">Basic Information</h2>
                            
                            <div class="space-y-6">
                                <!-- Product Title -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Product title</label>
                                    <input type="text" 
                                    id="title"
                                           name="productTitle" 
                                           class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Type product name here">
                                </div>
            
                                <!-- Full Description -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Full description</label>
                                    <textarea name="description",
                                     id="description" 

                                              rows="6" 
                                              class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                              placeholder="Type product description here"></textarea>
                                </div>
            
                                <!-- Pricing Section -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Regular price</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-3">â‚¹</span>
                                            <input type="number" 
                                            min="1"
                                                   id="regularPrice"
                                                   name="regularPrice" 
                                                   class=" positiveNumberInput w-full p-3 pl-8 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="0.00">
                                        </div>
                                        <span id="positiveNumberError" class="error-message"></span>
                                    </div>
            
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Offer Percentage</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-3">%</span>
                                            <input type="number" 
                                            min="1" max="99"
                                                   name="offerPrice" 
                                                   id="offerPrice"
                                                   class="  positiveNumberInput w-full p-3 pl-8 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   >
                                        </div>
                                        <span id="positiveNumberError" class="error-message"></span>
                                    </div>
            
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock quantity</label>
                                        <input type="number" 
                                        id="stock"
                                        min="0"
                                               name="stock" 
                                               class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500  positiveNumberInput"
                                               placeholder="Enter stock quantity">

                                    </div>
                                    <span id="positiveNumberError" class="error-message"></span>
                                </div>
                                <button type="submit" id="submit-botton" class="px-6 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Publish</button>

                            </div>

                        </div>
                        <!-- <button class="px-6 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Publish</button> -->

                        <!-- Media Section -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-xl font-semibold mb-6 text-gray-700">Media</h2>
                            
                            <!-- Image Upload Sections -->
                            <div class="space-y-6">
                                <!-- Main Image -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Main Image</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <input type="file" class="primaryImageInput"
                                               id="primaryImageInput" 
                                               accept="image/*" />
                                    </div>
                                </div>
                                
                                <!-- Modal for cropping -->
                                <div id="imageCropModal" style="display: none;">
                                    <img id="cropImage" alt="Image to crop" style="max-width: 100%;" />
                                    <button type="button" id="cropButton" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 mt-4">Crop</button>
                                </div>
                                
                     
                                <!-- Additional Images -->
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Image 2</label>
                                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                            <input type="file" 
                                                   name="image2" 
                                                   accept="image/*"
                                                   class=" image primaryImageInput" 
                                                   id="primaryImageInput">
                                           
                                            </label>
                                        </div>
                                    </div>
            
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Image 3</label>
                                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                            <input type="file" 
                                                   name="image3" 
                                                   accept="image/*"
                                                   class=" primaryImageInput" 
                                                   id="primaryImageInput">
                                           
                                        </div>
                                    </div>
                                </div>
                            </div>
            
                            <!-- Organization Section -->
                            <div class="mt-8">
                                <h2 class="text-xl font-semibold mb-6 text-gray-700">Organization</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                      
                                        <select id="category" name="category" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <% data.forEach(item => { %> 
                                                <option value="<%= item.category %>"><%= item.category %></option>
                                            <% }) %>
                                        </select>
                                        
                                     
                                    <!-- <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sub-category</label>
                                        <input type="text" id="subcategory" name="subcategory" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                         
                                    </div> -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <script src="/showNotification.js"></script>
              <script>
                console.log('jjjj');
                
            document.addEventListener('DOMContentLoaded', function () {
    const imageInputs = document.querySelectorAll('.primaryImageInput');
    const imageCropModal = document.getElementById('imageCropModal');
    const cropImage = document.getElementById('cropImage');
    const cropButton = document.getElementById('cropButton');
    let cropper;
    let croppedBlobs = []; // Array to store cropped blobs for each image input

    console.log(croppedBlobs);
    

    function handleImageCrop(file, inputIndex) {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            console.log('reader',reader);
            
            reader.onload = function (e) {
                cropImage.src = e.target.result;
                imageCropModal.style.display = 'block';

                if (cropper) cropper.destroy(); // Destroy any previous cropper instance

                cropper = new Cropper(cropImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                });

                // Set cropping action for the current input's cropped image
                cropButton.onclick = () => {
                    if (cropper) {
                        const canvas = cropper.getCroppedCanvas();
                        canvas.toBlob(blob => {
                            croppedBlobs[inputIndex] = blob; // Store cropped blob by input index
                            imageCropModal.style.display = 'none';
                            cropper.destroy();
                            cropper = null;
                        });
                    }
                };
            };
            reader.readAsDataURL(file);
        }
    }

    imageInputs.forEach((input, index) => {
        console.log(input,index,'primary');
        
        input.addEventListener('change', event => {
            const file = event.target.files[0];
            handleImageCrop(file, index);
        });
    });

    document.getElementById('addProductForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const title = document.getElementById("title").value.trim();
        if (!title.match(/^[A-Za-z][A-Za-z ]*$/)) {
            alert("Name should contain only letters and spaces.");
            return;
        }

        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', document.getElementById('description').value.trim());
        formData.append('regularPrice', document.getElementById('regularPrice').value.trim());
        formData.append('offerPrice', document.getElementById('offerPrice').value.trim());
        formData.append('category', document.getElementById('category').value.trim());
        formData.append('Stock', document.getElementById('stock').value.trim());

        imageInputs.forEach((input, index) => {
            const file = input.files[0];
            if (croppedBlobs[index]) {
    formData.append('primaryImageInput', croppedBlobs[index], `image-${index}-cropped.jpg`);
}

        });

        fetch('/admin/addProduct', {
            method: 'POST',
            body: formData
        }).then(res => res.json())
        .then(data =>{
            if(data.success){
                showToast(data.message, 'success');
                setTimeout(()=>{
                    location.reload()
                },1000)
                
            }else{
                showToast(data.message, 'error')
            }
            
        } )
      
    });
});

                
                </script>
            </section>
            
        </main>
        <script src="/admin/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="/admin/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="/admin/js/vendors/select2.min.js"></script>
        <script src="/admin/js/vendors/perfect-scrollbar.js"></script>
        <script src="/admin/js/vendors/jquery.fullscreen.min.js"></script>
        <!-- Main Script -->
        <script src="/admin/js/main.js?v=1.1" type="text/javascript"></script>
    </body>
</html>
