<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Nest Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />
        <!-- Favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="/admin/imgs/theme/favicon.svg" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <!-- Template CSS -->
        <link href="/admin/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="/SHOW.css">
        <style>
            body {
                font-family: 'Arial', sans-serif;
                margin: 20px;
            }
            
            h1 {
                font-size: 24px;
                text-align: center;
                margin-bottom: 20px;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
                box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            }
    
            th, td {
                padding: 10px;
                text-align: left;
                border: 1px solid #ddd;
            }
    
            th {
                background-color: #f2f2f2;
                color: #333;
                font-weight: bold;
            }
    
            td {
                background-color: #fafafa;
            }
    
            tr:nth-child(even) {
                background-color: #f9f9f9;
            }
    
            tr:hover {
                background-color: #f1f1f1;
            }
        </style>
           <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    </head>

    <body>
        <div class="screen-overlay"></div>
        <%-include('../partials/block.ejs')%>
       <%-include('../partials/sidebar.ejs')%>
        <main class="main-wrap">
          <%-include('../partials/adminHeader.ejs')%>
            <section class="content-main">
                <div class="container mt-5">
                    <h1 class="text-center">Sales Report</h1>
                    
                    <!-- Filters Section -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <form id="filter-form">
                                <div class="row g-3">
                                    <!-- Date Range -->
                                    <div class="col-md-4">
                                        <label for="startDate" class="form-label">Start Date</label>
                                        <input type="date" id="startDate" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="endDate" class="form-label">End Date</label>
                                        <input type="date" id="endDate" class="form-control" required>
                                    </div>
            
                                    <!-- Quick Filters -->
                                    <div class="col-md-4">
                                        <label for="quickFilter" class="form-label">Quick Filter</label>
                                        <select id="quickFilter" class="form-select">
                                            <option value="select">Select...</option>
                                            <option value="1Day">1 Day</option>
                                            <option value="1Week">1 Week</option>
                                            <option value="1Month">1 Month</option>
                                            <option value="all">All</option>
                                        </select>
                                    </div>
                                </div>
            
                                <div class="row mt-3">
                                    <div class="col text-end">
                                        <button type="button" class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                 <div id="pdfLoad">
                    <!-- Sales Metrics -->
                    <div class="card mt-4" id="revenue">
                        <div class="card-body">
                            <h4>Sales Metrics</h4>
                            <div class="row text-center">
                                <div class="col-md-4" style="color: #0080ff;">
                                    <h5 id="overallSalesCount">0</h5>
                                    <p>Overall Sales Count</p>
                                </div>
                                <div class="col-md-4" style="color: green;">
                                    <h5 id="overallOrderAmount">$0.00</h5>
                                    <p>Overall Order Amount</p>
                                </div>
                                <div class="col-md-4" style="color: rgb(255, 187, 0);">
                                    <h5 id="overallDiscount">$0.00</h5>
                                    <p>Total Discounts</p>
                                </div>
                            </div>
                        </div>
                    </div>
            
                    <!-- Sales Report Table -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h4>Sales Report</h4>
                            <table class="table table-striped mt-3" >
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Date</th>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        
                                        <th>Final Amount</th>
                                        <th>Discount</th>
                                        <th>Payment method</th>
                                        <th>Order Status</th>
                                        <th>Payment Status</th>
                                        
                                    </tr>
                                </thead>
                                <tbody id="salesReportTable">
                                    <tr>
                                        <td colspan="6" class="text-center">No data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                    <!-- Report Download -->
                    <div class="card mt-4">
                        <div class="card-body text-end">
                            <button class="btn btn-success me-2" onclick="downloadExcel()">Download Excel</button>
                            <button class="btn btn-danger" id="downloadButton">Download PDF</button>
                        </div>
                    </div>
                </div>
            </section>
            
        </main>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>

        <script src="/admin/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="/admin/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="/admin/js/vendors/select2.min.js"></script>
        <script src="/admin/js/vendors/perfect-scrollbar.js"></script>
        <script src="/admin/js/vendors/jquery.fullscreen.min.js"></script>
        <!-- Main Script -->
        <script src="/admin/js/main.js?v=1.1" type="text/javascript"></script>
        <script src="/TOAST.js"></script>

        <!--  category   -->
        <script>
            
            async function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const quickFilter = document.getElementById('quickFilter').value;
  
    if ((startDate && endDate) && quickFilter !== 'select') {
        showToast('Please select either a date range (Start Date and End Date) or a Quick Filter, but not both.');
        return;
    }

    try {
        const response = await fetch('/admin/get-sales-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ startDate, endDate, quickFilter }),
        });

        const result = await response.json();

        if (result.success) {
            const { metrics, orders } = result.data;

           

            
           
            localStorage.setItem('salesReportMetrics', JSON.stringify(metrics));
            localStorage.setItem('salesReportOrders', JSON.stringify(orders));

        
            updateMetrics(metrics);
          
            updateTable(orders);
        } else {
            alert('Failed to generate report.');
        }
    } catch (error) {
        console.error('Error generating report:', error);
        alert('Error generating report.');
    }
}

function updateMetrics(metrics) {
    document.getElementById('overallSalesCount').innerText = metrics.totalOrders;
    document.getElementById('overallOrderAmount').innerText = `₹${metrics.totalOrderAmount.toFixed(2)}`;
    document.getElementById('overallDiscount').innerText = `₹${metrics.totalDiscounts.toFixed(2)}`;
}

function updateTable(orders) {
    const table = document.getElementById('salesReportTable');
    table.innerHTML = orders.map((order, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${new Date(order.createdAt).toLocaleDateString()}</td>
            <td>${order._id}</td>
            <td>${order.UserID.firstName}</td> <!-- User's name -->
           
            <td>₹${order.Final_Amount.toFixed(2)}</td>
            <td>₹${order.Coupon.discountValue.toFixed(2)}</td>
            <td>${order.payment}</td>
            <td>${order.orderStatus}</td>
            <td>${order.paymentStatus}</td>
        </tr>
    `).join('');
}
document.addEventListener('DOMContentLoaded', () => {
    const storedMetrics = localStorage.getItem('salesReportMetrics');
    const storedOrders = localStorage.getItem('salesReportOrders');

    if (storedMetrics && storedOrders) {
        const metrics = JSON.parse(storedMetrics);
        const orders = JSON.parse(storedOrders);

        // Update metrics and table with the stored data
        updateMetrics(metrics);
        updateTable(orders);
    }
});



        function downloadExcel() {
            
            var table = document.getElementById("pdfLoad");
            var wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
            XLSX.writeFile(wb, "data.xlsx");
        
        }

        
           
const downloadButton = document.getElementById('downloadButton');


downloadButton.addEventListener('click', function () {
    const pdfContainer = document.createElement('div');
    pdfContainer.style.padding = '20px'; 
   
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const quickFilter = document.getElementById('quickFilter').value;

    const today = new Date();
    const formattedToday = today.toLocaleDateString('en-GB'); 

    const dateParagraph = document.createElement('p');
    dateParagraph.style.textAlign = 'right';
    dateParagraph.style.fontSize = '14px';

    
    if (startDate && endDate) {
     
        const formattedStartDate = new Date(startDate).toLocaleDateString('en-GB');
        const formattedEndDate = new Date(endDate).toLocaleDateString('en-GB');
        dateParagraph.innerText = `Report from: ${formattedStartDate} to ${formattedEndDate}`;
    } else if (quickFilter === '1Day') {
        dateParagraph.innerText = `Report Date: ${formattedToday}`;
    } else if (quickFilter === '1Week') {
        const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const formattedWeekAgo = oneWeekAgo.toLocaleDateString('en-GB');
        dateParagraph.innerText = `Report: Week Ending ${formattedToday} (From ${formattedWeekAgo})`;
    } else {
        dateParagraph.innerText = `Report Date: ${formattedToday}`;
    }

    
    pdfContainer.appendChild(dateParagraph);

    const tableElement = document.getElementById('pdfLoad'); 
    const clonedTable = tableElement.cloneNode(true);
    pdfContainer.appendChild(clonedTable);

    
    html2pdf(pdfContainer, {
        margin: 10,
        filename: `sales_report_${formattedToday}.pdf`,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    });


});


        


        </script>
    </body>
</html>



